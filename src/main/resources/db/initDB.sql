DROP TABLE user_roles IF EXISTS;
DROP TABLE users IF EXISTS;
DROP TABLE roles IF EXISTS;
DROP TABLE dishes IF EXISTS;
DROP TABLE menu IF EXISTS;
DROP TABLE rating IF EXISTS;
DROP TABLE restaurants IF EXISTS;
DROP SEQUENCE GLOBAL_SEQ IF EXISTS;

CREATE SEQUENCE GLOBAL_SEQ AS INTEGER START WITH 100000;

CREATE TABLE roles
(
    id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    name VARCHAR(100) NOT NULL
);
CREATE UNIQUE INDEX roles_unique_name_idx ON roles (name);

CREATE TABLE users
(
    id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    email VARCHAR(200) NOT NULL,
    password VARCHAR(200) NOT NULL,
    registered TIMESTAMP DEFAULT now() NOT NULL
);
CREATE UNIQUE INDEX users_unique_email_idx ON users (email);

CREATE TABLE user_roles
(
    id_user INTEGER NOT NULL,
    id_role INTEGER NOT NULL,
    PRIMARY KEY (id_user, id_role),
    FOREIGN KEY (id_user) REFERENCES users(id) ON DELETE CASCADE,
    FOREIGN KEY (id_role) REFERENCES roles(id) ON DELETE CASCADE
);

CREATE TABLE restaurants
(
    id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    name VARCHAR(200) NOT NULL
);
CREATE UNIQUE INDEX restaurants_unique_name_idx ON restaurants (name);

CREATE TABLE dishes
(
    id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    deleted BOOLEAN DEFAULT FALSE NOT NULL
);
CREATE UNIQUE INDEX dish_unique_name_idx ON dishes (name);

CREATE TABLE menu
(
    id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    id_restaurant INTEGER NOT NULL,
    id_dish INTEGER NOT NULL,
    price_dish INTEGER NOT NULL,
    date_last TIMESTAMP DEFAULT now() NOT NULL,
    FOREIGN KEY (id_restaurant) REFERENCES restaurants(id) ON DELETE CASCADE,
    FOREIGN KEY (id_dish) REFERENCES dishes(id) ON DELETE CASCADE
);
CREATE UNIQUE INDEX menu_unique_dish_idx ON menu (id_restaurant, id_dish);

CREATE TABLE rating
(
    id INTEGER GENERATED BY DEFAULT AS SEQUENCE GLOBAL_SEQ PRIMARY KEY,
    id_user INTEGER NOT NULL,
    assessment INTEGER NOT NULL,
    id_restaurant INTEGER NOT NULL,
    date_create TIMESTAMP DEFAULT now() NOT NULL,
    FOREIGN KEY (id_restaurant) REFERENCES restaurants(id) ON DELETE CASCADE
);
CREATE UNIQUE INDEX rating_unique_users_assessment_on_date_idx ON rating (id_user, assessment, date_create);